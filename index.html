# 🚀 Supabase设置指南

这份指南将帮助您配置Supabase后端，实现多设备数据同步和多用户支持。

---

## 📋 目录

1. [创建Supabase账号](#1-创建supabase账号)
2. [创建新项目](#2-创建新项目)
3. [设置数据库](#3-设置数据库)
4. [配置Google OAuth](#4-配置google-oauth)
5. [获取API密钥](#5-获取api密钥)
6. [更新前端代码](#6-更新前端代码)
7. [测试应用](#7-测试应用)
8. [故障排除](#8-故障排除)

---

## 1. 创建Supabase账号

1. 访问 [https://supabase.com](https://supabase.com)
2. 点击 **"Start your project"** 或 **"Sign Up"**
3. 使用GitHub账号登录（推荐）或使用邮箱注册
4. 完成账号创建

---

## 2. 创建新项目

1. 登录后，点击 **"New Project"**
2. 选择您的组织（如果没有，会自动创建）
3. 填写项目信息：
   - **Name**: `week-plan` 或您喜欢的名称
   - **Database Password**: 设置一个强密码（请保存好！）
   - **Region**: 选择 **Northeast Asia (Tokyo)** （距离中国最近）
   - **Pricing Plan**: 选择 **Free** （免费版）
4. 点击 **"Create new project"**
5. 等待2-3分钟，项目初始化完成

---

## 3. 设置数据库

### 3.1 创建表

1. 在左侧菜单中，点击 **"Table Editor"**
2. 点击 **"Create a new table"**
3. 配置表：
   - **Name**: `user_tasks`
   - **Description**: `用户任务数据`
   - **Enable Row Level Security (RLS)**: ✅ **勾选**

### 3.2 添加列

保留默认的 `id` 和 `created_at` 列，然后添加以下列：

| Column Name | Type | Default Value | Additional Settings |
|------------|------|---------------|-------------------|
| `user_id` | `uuid` | - | ✅ Is Nullable: 取消勾选 |
| `tasks` | `jsonb` | `[]` | ✅ Is Nullable: 勾选 |
| `calendar_tasks` | `jsonb` | `[]` | ✅ Is Nullable: 勾选 |
| `updated_at` | `timestamptz` | `now()` | ✅ Is Nullable: 勾选 |

### 3.3 设置主键和唯一约束

1. 点击表名旁的 ⚙️ **"Settings"**
2. 添加唯一约束：
   - 点击 **"Add Unique Constraint"**
   - 选择 `user_id` 列
   - 点击 **"Save"**

### 3.4 配置行级安全(RLS)策略

非常重要！这确保用户只能访问自己的数据。

#### 方法1：使用SQL编辑器（推荐）

1. 在左侧菜单中，点击 **"SQL Editor"**
2. 点击 **"New query"**
3. 粘贴以下SQL代码：

```sql
-- 创建策略：允许用户读取自己的数据
CREATE POLICY "Users can read own tasks" ON user_tasks
    FOR SELECT
    USING (auth.uid() = user_id);

-- 创建策略：允许用户插入自己的数据
CREATE POLICY "Users can insert own tasks" ON user_tasks
    FOR INSERT
    WITH CHECK (auth.uid() = user_id);

-- 创建策略：允许用户更新自己的数据
CREATE POLICY "Users can update own tasks" ON user_tasks
    FOR UPDATE
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);

-- 创建策略：允许用户删除自己的数据
CREATE POLICY "Users can delete own tasks" ON user_tasks
    FOR DELETE
    USING (auth.uid() = user_id);
```

4. 点击 **"Run"** 执行SQL
5. 确认显示 **"Success"**

#### 方法2：使用UI界面

1. 在 **Table Editor** 中，选择 `user_tasks` 表
2. 点击 **"Policies"** 标签
3. 点击 **"New Policy"**
4. 选择 **"Create a policy from scratch"**
5. 重复以下步骤4次（SELECT, INSERT, UPDATE, DELETE）：

**SELECT Policy:**
- Policy Name: `Users can read own tasks`
- Target roles: `public`
- Command: `SELECT`
- USING expression: `auth.uid() = user_id`

**INSERT Policy:**
- Policy Name: `Users can insert own tasks`
- Target roles: `public`
- Command: `INSERT`
- WITH CHECK expression: `auth.uid() = user_id`

**UPDATE Policy:**
- Policy Name: `Users can update own tasks`
- Target roles: `public`
- Command: `UPDATE`
- USING expression: `auth.uid() = user_id`
- WITH CHECK expression: `auth.uid() = user_id`

**DELETE Policy:**
- Policy Name: `Users can delete own tasks`
- Target roles: `public`
- Command: `DELETE`
- USING expression: `auth.uid() = user_id`

---

## 4. 配置Google OAuth

### 4.1 创建Google OAuth凭据

1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 创建新项目或选择现有项目
3. 启用 **Google+ API**：
   - 搜索 "Google+ API"
   - 点击 **"Enable"**
4. 创建OAuth凭据：
   - 左侧菜单 → **APIs & Services** → **Credentials**
   - 点击 **"Create Credentials"** → **"OAuth client ID"**
   - Application type: **Web application**
   - Name: `Week Plan`
   - Authorized redirect URIs（非常重要！）：
     - 回到Supabase，左侧菜单 → **Authentication** → **Providers**
     - 找到 **Google** 提供商
     - 复制 **"Callback URL (for OAuth)"**（类似：`https://xxx.supabase.co/auth/v1/callback`）
     - 粘贴到Google Console的"Authorized redirect URIs"
   - 点击 **"Create"**
5. 复制生成的：
   - **Client ID**
   - **Client Secret**

### 4.2 在Supabase中配置Google

1. 在Supabase，左侧菜单 → **Authentication** → **Providers**
2. 找到 **Google**，点击展开
3. 打开 **"Enable Sign in with Google"** 开关
4. 填入：
   - **Client ID**: 粘贴Google的Client ID
   - **Client Secret**: 粘贴Google的Client Secret
5. 点击 **"Save"**

---

## 5. 获取API密钥

1. 在Supabase，左侧菜单 → **Settings** → **API**
2. 找到以下信息：
   - **Project URL** (例如: `https://xxxxx.supabase.co`)
   - **anon public** key (以 `eyJ` 开头的长字符串)
3. **复制这两个值，接下来要用**

---

## 6. 更新前端代码

1. 打开 `index.htmlu` 文件
2. 找到第594-595行（在 `<script>` 标签内）：

```javascript
const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE'
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE'
```

3. 替换为您的实际值：

```javascript
const SUPABASE_URL = 'https://xxxxx.supabase.co'  // 替换为您的Project URL
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'  // 替换为您的anon key
```

4. 保存文件

---

## 7. 测试应用

### 7.1 本地测试

1. 在浏览器中打开 `index.html`
2. 检查浏览器控制台（F12），应该看到：
   ```
   ✅ Supabase initialized
   ```
3. 点击 **"登录"** 按钮
4. 尝试以下登录方式：

#### 测试邮箱登录：
1. 点击 **"注册"**
2. 输入邮箱和密码（至少6位）
3. 点击 **"注册"**
4. 检查邮箱，点击验证链接
5. 返回应用，点击 **"登录"**
6. 使用相同的邮箱和密码登录

#### 测试Google登录：
1. 点击 **"使用 Google 登录"**
2. 选择Google账号
3. 允许授权
4. 应该自动返回应用并登录成功

### 7.2 验证功能

登录成功后，应该看到：
- ✅ 左侧面板显示用户头像和邮箱
- ✅ 显示 **"同步"** 和 **"登出"** 按钮
- ✅ 可以创建任务
- ✅ 任务自动保存到云端

### 7.3 测试跨设备同步

1. 在第一个设备上创建一些任务
2. 在第二个设备（或浏览器隐身模式）打开应用
3. 使用相同账号登录
4. 应该看到相同的任务数据！

---

## 8. 故障排除

### ❌ 控制台显示 "Supabase not configured"

**原因**: 未正确配置API密钥

**解决方案**:
- 检查 `SUPABASE_URL` 和 `SUPABASE_ANON_KEY` 是否正确
- 确保没有多余的空格或引号
- 保存文件后刷新浏览器

---

### ❌ Google登录失败 "redirect_uri_mismatch"

**原因**: Google Console中的重定向URI配置错误

**解决方案**:
1. 回到Supabase → **Authentication** → **Providers** → **Google**
2. 复制完整的 "Callback URL"
3. 回到Google Console → **Credentials**
4. 编辑OAuth客户端
5. 确保 "Authorized redirect URIs" **完全匹配** Supabase的Callback URL
6. 保存后等待5分钟再测试

---

### ❌ 邮箱注册后无法登录

**原因**: 邮箱未验证

**解决方案**:
1. 检查邮箱的垃圾邮件文件夹
2. 找到Supabase发送的验证邮件
3. 点击验证链接
4. 返回应用重新登录

如果没收到邮件：
1. Supabase → **Authentication** → **Providers** → **Email**
2. 检查 "Confirm email" 是否开启
3. 可以暂时关闭以便测试（不推荐生产环境）

---

### ❌ RLS错误 "new row violates row-level security policy"

**原因**: RLS策略配置错误

**解决方案**:
1. 重新执行第3.4节的SQL命令
2. 或者在 Supabase → **Table Editor** → `user_tasks` → **Policies**
3. 确保所有4个策略（SELECT, INSERT, UPDATE, DELETE）都已创建
4. 检查策略的表达式是否为 `auth.uid() = user_id`

---

### ❌ 数据没有同步

**原因**: 浏览器缓存或网络问题

**解决方案**:
1. 点击 **"同步"** 按钮手动同步
2. 检查浏览器控制台是否有错误
3. 刷新页面 (F5)
4. 检查 Supabase → **Table Editor** → `user_tasks`，确认数据已保存

---

## 🎉 完成！

恭喜！您已经成功配置了Supabase后端。现在您的应用支持：

✅ **用户认证** (Google + 邮箱/密码)
✅ **多用户隔离** (每个用户只能看到自己的数据)
✅ **跨设备同步** (在任何设备登录都能看到数据)
✅ **云端备份** (数据安全存储在Supabase)
✅ **免费使用** (Supabase免费版非常慷慨)

---

## 📊 免费版限额

Supabase免费版提供：
- ✅ 500MB 数据库存储
- ✅ 50,000 月活跃用户
- ✅ 2GB 带宽/月
- ✅ 社区支持

对于个人使用或小型团队，免费版完全够用！

---

## 🚀 下一步（可选）

### 部署到Vercel（免费托管）

1. 访问 [vercel.com](https://vercel.com)
2. 注册并连接GitHub
3. 创建新仓库，上传 `index.html`
4. 在Vercel导入仓库
5. 部署完成后，您将获得一个公开URL
6. 记得更新Google OAuth的重定向URI！

### 添加实时同步（高级）

如果您想要多设备实时同步（不需要点击"同步"按钮），可以添加：

```javascript
// 在 script 中添加
if (supabase) {
    supabase
        .channel('tasks-changes')
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'user_tasks',
            filter: `user_id=eq.${currentUser?.id}`
        }, (payload) => {
            console.log('数据更新！', payload)
            loadDataFromSupabase()
        })
        .subscribe()
}
```

---

## 💡 需要帮助？

如果遇到任何问题：

1. 检查浏览器控制台 (F12) 查看错误信息
2. 查看Supabase文档: [https://supabase.com/docs](https://supabase.com/docs)
3. 联系我获取更多帮助

---

**祝您使用愉快！** 🎉✨

